name: Deploy to Dev

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Pull Docker image
      run: |
        echo "ðŸ³ Pulling Docker image..."
        docker pull ${{ secrets.DOCKER_USERNAME }}/iris-classifier:${{ github.sha }}

    - name: Deploy to Dev
      env:
        DEV_API_URL: ${{ secrets.DEV_API_URL }}
      run: |
        echo "ðŸš€ Deploying to Dev environment..."
        docker run -d \
          -p 8000:8000 \
          -e ENVIRONMENT=dev \
          --name iris-classifier-dev \
          ${{ secrets.DOCKER_USERNAME }}/iris-classifier:${{ github.sha }}



    - name: Display Docker logs for debugging
      run: |
        echo "ðŸ”Ž Displaying logs for iris-classifier-dev..."
        docker logs iris-classifier-dev
    - name: Wait for container to be healthy
      run: |
        echo "Waiting for container to start..."
        for i in {1..20}; do
          if curl -s -f http://localhost:8000/healthz > /dev/null; then
            echo "Container is healthy!"
            exit 0
          fi
          echo "Attempt $i: Container not ready yet. Retrying in 3 seconds..."
          sleep 3
        done
        echo "Error: Container did not become healthy in time."
        exit 1

    - name: Smoke test - /predict
      run: |
        echo "ðŸ§ª Testing /predict endpoint..."
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{"features": [5.1, 3.5, 1.4, 0.2]}' || exit 1
        echo "âœ… /predict passed"

    # - name: Notify Slack - Dev Deployment
    #   if: always()
    #   uses: slackapi/slack-github-action@v1.24.0
    #   with:
    #     webhook-url: ${{ secrets.SLACK_WEBHOOK }}
    #     payload: |
    #       {
    #         "text": "Dev Deployment Status",
    #         "blocks": [
    #           {
    #             "type": "section",
    #             "text": {
    #               "type": "mrkdwn",
    #               "text": "*Dev Deployment*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nTriggered by: ${{ github.actor }}"
    #             }
    #           }
    #         ]
    #       }

