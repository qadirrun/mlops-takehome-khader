name: Deploy to Dev

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: read

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull Docker image
      run: |
        echo "üê≥ Pulling Docker image..."
        IMAGE_TAG="ghcr.io/${{ github.repository }}:main-${{ github.event.workflow_run.head_sha }}"
        echo "Pulling: $IMAGE_TAG"
        docker pull $IMAGE_TAG || docker pull ghcr.io/${{ github.repository }}:latest

    - name: Deploy to Dev
      env:
        DEV_API_URL: ${{ secrets.DEV_API_URL }}
      run: |
        echo "üöÄ Deploying to Dev environment..."
        IMAGE_TAG="ghcr.io/${{ github.repository }}:main-${{ github.event.workflow_run.head_sha }}"
        docker run -d \
          -p 8000:8000 \
          -e ENVIRONMENT=dev \
          --name iris-classifier-dev \
          $IMAGE_TAG || docker run -d \
          -p 8000:8000 \
          -e ENVIRONMENT=dev \
          --name iris-classifier-dev \
          ghcr.io/${{ github.repository }}:latest



    - name: Display Docker logs for debugging
      run: |
        echo "üîé Displaying logs for iris-classifier-dev..."
        docker logs iris-classifier-dev
    - name: Wait for container to be healthy
      run: |
        echo "Waiting for container to start (may take longer if training model)..."
        for i in {1..40}; do
          if curl -s -f http://localhost:8000/healthz > /dev/null; then
            echo "‚úÖ Container is healthy!"
            exit 0
          fi
          echo "Attempt $i/40: Container not ready yet. Retrying in 5 seconds..."
          sleep 5
        done
        echo "‚ùå Error: Container did not become healthy in time."
        echo "üìã Container logs:"
        docker logs iris-classifier-dev
        exit 1

    - name: Smoke test - /predict
      run: |
        echo "üß™ Testing /predict endpoint..."
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{"features": [5.1, 3.5, 1.4, 0.2]}' || exit 1
        echo "‚úÖ /predict passed"

    # - name: Notify Slack - Dev Deployment
    #   if: always()
    #   uses: slackapi/slack-github-action@v1.24.0
    #   with:
    #     webhook-url: ${{ secrets.SLACK_WEBHOOK }}
    #     payload: |
    #       {
    #         "text": "Dev Deployment Status",
    #         "blocks": [
    #           {
    #             "type": "section",
    #             "text": {
    #               "type": "mrkdwn",
    #               "text": "*Dev Deployment*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nTriggered by: ${{ github.actor }}"
    #             }
    #           }
    #         ]
    #       }

