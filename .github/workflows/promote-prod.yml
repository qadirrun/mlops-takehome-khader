name: Promote Prod

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to deploy'
        required: true
        default: 'iris-logistic-regression'
        type: choice
        options:
          - iris-logistic-regression
          - iris-random-forest
          - iris-svm
      canary_percentage:
        description: 'Canary traffic percentage'
        required: true
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '25'
          - '50'

jobs:
  canary-rollout:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mlflow_user
          POSTGRES_PASSWORD: mlflow_password
          POSTGRES_DB: iris_logs
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull Docker image
      run: |
        echo "üê≥ Pulling Docker image..."
        docker pull ghcr.io/${{ github.repository }}:latest

    - name: Deploy Canary (${{ github.event.inputs.canary_percentage }}% traffic)
      env:
        PROD_API_URL: ${{ secrets.PROD_API_URL }}
      run: |
        echo "üöÄ Deploying canary: ${{ github.event.inputs.model_name }}"
        echo "   Traffic: ${{ github.event.inputs.canary_percentage }}%"
        docker run -d \
          -p 8001:8000 \
          -e ENVIRONMENT=prod \
          -e MODEL_NAME=${{ github.event.inputs.model_name }} \
          -e CANARY_PERCENTAGE=${{ github.event.inputs.canary_percentage }} \
          -e DB_HOST=172.17.0.1 \
          -e DB_USER=mlflow_user \
          -e DB_PASSWORD=mlflow_password \
          -e DB_NAME=iris_logs \
          --name iris-classifier-canary \
          ghcr.io/${{ github.repository }}:latest
        sleep 10

    - name: Wait for canary to be healthy
      run: |
        echo "‚è≥ Waiting for canary container to be healthy..."
        for i in {1..40}; do
          if curl -s -f http://localhost:8001/healthz > /dev/null; then
            echo "‚úÖ Canary container is healthy!"
            exit 0
          fi
          echo "Attempt $i/40: Container not ready yet. Retrying in 5 seconds..."
          sleep 5
        done
        echo "‚ùå Error: Canary container did not become healthy in time."
        echo "üìã Container logs:"
        docker logs iris-classifier-canary
        exit 1

    - name: Smoke test - Canary /healthz
      run: |
        echo "üß™ Testing canary /healthz endpoint..."
        curl -f http://localhost:8001/healthz || exit 1
        echo "‚úÖ Canary /healthz passed"

    - name: Smoke test - Canary /predict
      run: |
        echo "üß™ Testing canary /predict endpoint..."
        curl -f -X POST http://localhost:8001/predict \
          -H "Content-Type: application/json" \
          -d '{"features": [5.1, 3.5, 1.4, 0.2]}' || exit 1
        echo "‚úÖ Canary /predict passed"

    - name: Monitor canary (5 min)
      run: |
        echo "üìä Monitoring canary deployment for 5 minutes..."
        for i in {1..5}; do
          echo "  [$i/5] Checking metrics..."
          sleep 60
        done
        echo "‚úÖ Canary monitoring completed"

    - name: Create canary record
      run: |
        cat > deploy/canary_record.json << EOF
        {
          "model": "${{ github.event.inputs.model_name }}",
          "canary_percentage": ${{ github.event.inputs.canary_percentage }},
          "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
          "triggered_by": "${{ github.actor }}",
          "commit": "${{ github.sha }}"
        }
        EOF
        cat deploy/canary_record.json

  full-promotion:
    needs: canary-rollout
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write
      packages: read

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mlflow_user
          POSTGRES_PASSWORD: mlflow_password
          POSTGRES_DB: iris_logs
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull Docker image
      run: |
        echo "üê≥ Pulling Docker image..."
        docker pull ghcr.io/${{ github.repository }}:latest

    - name: Deploy Full Prod (100% traffic)
      env:
        PROD_API_URL: ${{ secrets.PROD_API_URL }}
      run: |
        echo "üöÄ Full promotion: ${{ github.event.inputs.model_name }}"
        docker run -d \
          -p 8000:8000 \
          -e ENVIRONMENT=prod \
          -e MODEL_NAME=${{ github.event.inputs.model_name }} \
          -e DB_HOST=172.17.0.1 \
          -e DB_USER=mlflow_user \
          -e DB_PASSWORD=mlflow_password \
          -e DB_NAME=iris_logs \
          --name iris-classifier-prod \
          ghcr.io/${{ github.repository }}:latest
        sleep 10

    - name: Wait for prod to be healthy
      run: |
        echo "‚è≥ Waiting for prod container to be healthy..."
        for i in {1..40}; do
          if curl -s -f http://localhost:8000/healthz > /dev/null; then
            echo "‚úÖ Prod container is healthy!"
            exit 0
          fi
          echo "Attempt $i/40: Container not ready yet. Retrying in 5 seconds..."
          sleep 5
        done
        echo "‚ùå Error: Prod container did not become healthy in time."
        echo "üìã Container logs:"
        docker logs iris-classifier-prod
        exit 1

    - name: Smoke test - Prod /healthz
      run: |
        echo "üß™ Testing prod /healthz endpoint..."
        curl -f http://localhost:8000/healthz || exit 1
        echo "‚úÖ Prod /healthz passed"

    - name: Smoke test - Prod /predict
      run: |
        echo "üß™ Testing prod /predict endpoint..."
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{"features": [5.1, 3.5, 1.4, 0.2]}' || exit 1
        echo "‚úÖ Prod /predict passed"

    - name: Create release tag
      run: |
        TAG_NAME="prod-${{ github.event.inputs.model_name }}-${{ github.run_number }}"
        echo "Creating tag: $TAG_NAME"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$TAG_NAME" -m "Production promotion: ${{ github.event.inputs.model_name }}"
        git push origin "$TAG_NAME"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: prod-${{ github.event.inputs.model_name }}-${{ github.run_number }}
        name: Prod - ${{ github.event.inputs.model_name }}
        body: |
          ## Production Promotion
          - **Model**: ${{ github.event.inputs.model_name }}
          - **Canary**: ${{ github.event.inputs.canary_percentage }}%
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: ${{ github.actor }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # - name: Notify Slack - Promotion Complete
    #   if: always()
    #   uses: slackapi/slack-github-action@v1.24.0
    #   with:
    #     webhook-url: ${{ secrets.SLACK_WEBHOOK }}
    #     payload: |
    #       {
    #         "text": "Production Promotion Complete",
    #         "blocks": [
    #           {
    #             "type": "section",
    #             "text": {
    #               "type": "mrkdwn",
    #               "text": "*Production Promotion*\nModel: ${{ github.event.inputs.model_name }}\nCanary: ${{ github.event.inputs.canary_percentage }}% ‚Üí 100%\nStatus: ${{ job.status }}\nTriggered by: ${{ github.actor }}"
    #             }
    #           }
    #         ]
    #       }

